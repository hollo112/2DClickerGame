name: Unity WebGL Build

on:
  push:
    branches: [ web-build ]

# GitHub Pages ë°°í¬ì— í•„ìš”í•œ ê¶Œí•œ
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 0. ë””ìŠ¤í¬ ê³µê°„ í™•ë³´
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout
        uses: actions/checkout@v4

      # 2. ìºì‹œ (ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-WebGL-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-WebGL-
            Library-

      # 3. Unity ë¹Œë“œ
      - name: Build WebGL
        id: build
        continue-on-error: true
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: WebGL
          buildProfile: "Assets/Settings/Build Profiles/Web - Desktop - Release.asset"

      # 4. ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      - name: Upload Build
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: WebGL-Build
          path: build/WebGL

      # 5. GitHub Pages ë°°í¬ ì¤€ë¹„
      - name: Setup Pages
        if: steps.build.outcome == 'success'
        uses: actions/configure-pages@v5

      # 6. Pagesìš© Artifact ì—…ë¡œë“œ
      - name: Upload Pages Artifact
        if: steps.build.outcome == 'success'
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/WebGL/WebGL

      # 7. GitHub Pages ë°°í¬
      - name: Deploy to GitHub Pages
        if: steps.build.outcome == 'success'
        uses: actions/deploy-pages@v4

      # 8. Butler ì„¤ì¹˜ & Itch.io ë°°í¬
      - name: Install Butler
        if: steps.build.outcome == 'success'
        run: |
          curl -L -o butler.zip https://broth.itch.zone/butler/linux-amd64/LATEST/archive/default
          unzip butler.zip
          chmod +x butler
          ./butler -V

      - name: Push to Itch.io
        if: steps.build.outcome == 'success'
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        run: |
          ./butler push build/WebGL/WebGL ${{ secrets.ITCHIO_GAME }}:html5

      # 9. ë¹Œë“œ ì‹¤íŒ¨ ì‹œ Geminië¡œ ì—ëŸ¬ ë¶„ì„
      - name: Analyze Build Error with Gemini
        id: analyze
        if: steps.build.outcome == 'failure'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          ERROR_FILE=/tmp/build_errors.txt
          touch "$ERROR_FILE"

          find "$GITHUB_WORKSPACE" /home /tmp -name "*.log" -type f 2>/dev/null | head -10 | while read -r f; do
            grep -i -E "error|fatal|exception|failed" "$f" 2>/dev/null | tail -20 >> "$ERROR_FILE"
          done

          if [ ! -s "$ERROR_FILE" ]; then
            echo "Build failed but no specific error logs were found." > "$ERROR_FILE"
          fi

          ERROR_LOG=$(tail -40 "$ERROR_FILE" | head -c 2000)

          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "ë‹¤ìŒ Unity WebGL ë¹Œë“œ ì—ëŸ¬ ë¡œê·¸ë¥¼ ë¶„ì„í•´ì¤˜. í•œêµ­ì–´ë¡œ ì›ì¸ê³¼ í•´ê²°ë°©ë²•ì„ 3ì¤„ ì´ë‚´ë¡œ ì„¤ëª…. ë§ˆí¬ë‹¤ìš´ ê¸ˆì§€:\n\n${ERROR_LOG}" \
              '{contents:[{parts:[{text:$prompt}]}]}')" || true)

          ANALYSIS=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "AI ë¶„ì„ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."' | head -5)

          {
            echo "analysis<<ANALYSIS_EOF"
            echo "$ANALYSIS"
            echo "ANALYSIS_EOF"
          } >> "$GITHUB_OUTPUT"

      # 10. ìŠ¬ë™ ì•Œë¦¼ (ì„±ê³µ)
      - name: Slack Notification (Success)
        if: steps.build.outcome == 'success'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |
            text: "âœ… WebGL ë¹Œë“œ & ë°°í¬ ì„±ê³µ"
            blocks:
              - type: section
                text:
                  type: mrkdwn
                  text: |
                    âœ… *${{ github.repository }}* ë¹Œë“œ & ë°°í¬ ì™„ë£Œ!
                    ğŸ“ ì»¤ë°‹: ${{ github.event.head_commit.message }}
                    ğŸ‘¤ ì‘ì„±ì: ${{ github.actor }}
                    ğŸŒ <https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/|í”Œë ˆì´í•˜ê¸°>
                    ğŸ® <${{ secrets.ITCHIO_GAME_URL }}|Itch.ioì—ì„œ í”Œë ˆì´>

      # 11. ìŠ¬ë™ ì•Œë¦¼ (ì‹¤íŒ¨ + AI ë¶„ì„)
      - name: Slack Notification (Failure)
        if: steps.build.outcome == 'failure'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |
            text: "âŒ WebGL ë¹Œë“œ ì‹¤íŒ¨"
            blocks:
              - type: section
                text:
                  type: mrkdwn
                  text: |
                    ğŸ”¥ *${{ github.repository }}* ë¹Œë“œ ì‹¤íŒ¨!
                    ğŸ“ ì»¤ë°‹: ${{ github.event.head_commit.message }}
                    ğŸ‘¤ ì‘ì„±ì: ${{ github.actor }}
                    ğŸ”— <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ë¡œê·¸ í™•ì¸>
              - type: section
                text:
                  type: mrkdwn
                  text: |
                    ğŸ¤– *Gemini AI ë¶„ì„:*
                    ${{ steps.analyze.outputs.analysis }}

      # 12. ë¹Œë“œ ì‹¤íŒ¨ ì‹œ Jobì„ ì‹¤íŒ¨ ìƒíƒœë¡œ ë§ˆí‚¹
      - name: Fail job if build failed
        if: steps.build.outcome == 'failure'
        run: exit 1
