name: Unity WebGL Build

on:
  push:
    branches: [ web-build ]
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ 09:00 KST (00:00 UTC)

# GitHub Pages ë°°í¬ì— í•„ìš”í•œ ê¶Œí•œ
permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 0. ë””ìŠ¤í¬ ê³µê°„ í™•ë³´
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'schedule' && 'main' || '' }}
          fetch-depth: 0

      # 1.1. ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ì‹œ ë³€ê²½ ì‚¬í•­ í™•ì¸
      - name: Check for changes
        id: changes
        if: github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          PREV_SHA=$(gh api \
            "repos/${{ github.repository }}/actions/workflows/demo.yml/runs?branch=main&status=success&per_page=1" \
            --jq '.workflow_runs[0].head_sha' 2>/dev/null || echo "")

          if [ -n "$PREV_SHA" ] && [ "$PREV_SHA" != "null" ] && [ "$CURRENT_SHA" = "$PREV_SHA" ]; then
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            echo "::notice::ë³€ê²½ ì‚¬í•­ ì—†ìŒ - ë¹Œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          else
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            echo "::notice::ë³€ê²½ ì‚¬í•­ ê°ì§€ - ë¹Œë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤. (ì´ì „: ${PREV_SHA:-ì—†ìŒ}, í˜„ì¬: $CURRENT_SHA)"
          fi

      # 1.5. ì´ì „ ë¹Œë“œ ëŒ€ë¹„ ì»¤ë°‹ ë‚´ì—­ ìˆ˜ì§‘
      - name: Get Commit History
        id: commits
        if: github.event_name == 'push' || steps.changes.outputs.should_build == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # ì´ì „ ì„±ê³µí•œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì˜ ì»¤ë°‹ SHA ê°€ì ¸ì˜¤ê¸°
          BRANCH=${{ github.event_name == 'schedule' && 'main' || 'web-build' }}
          PREV_SHA=$(gh api \
            "repos/${{ github.repository }}/actions/workflows/demo.yml/runs?branch=${BRANCH}&status=success&per_page=1" \
            --jq '.workflow_runs[0].head_sha' 2>/dev/null || echo "")

          if [ -z "$PREV_SHA" ] || [ "$PREV_SHA" = "null" ]; then
            echo "log=ì²« ë²ˆì§¸ ë¹Œë“œì…ë‹ˆë‹¤." >> "$GITHUB_OUTPUT"
          elif [ "$PREV_SHA" = "${{ github.sha }}" ]; then
            echo "log=ì´ì „ ë¹Œë“œì™€ ë™ì¼í•œ ì»¤ë°‹ì…ë‹ˆë‹¤." >> "$GITHUB_OUTPUT"
          else
            # ì»¤ë°‹ ë¡œê·¸ ìˆ˜ì§‘ (ìµœëŒ€ 10ê°œ)
            COMMITS=$(git log --oneline --no-merges "${PREV_SHA}..${{ github.sha }}" 2>/dev/null | head -10)
            TOTAL=$(git rev-list --count --no-merges "${PREV_SHA}..${{ github.sha }}" 2>/dev/null || echo "0")

            if [ -z "$COMMITS" ]; then
              echo "log=ì»¤ë°‹ ë‚´ì—­ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> "$GITHUB_OUTPUT"
            else
              FORMATTED=$(echo "$COMMITS" | while IFS= read -r line; do echo "â€¢ ${line}"; done)
              if [ "$TOTAL" -gt 10 ]; then
                FORMATTED="${FORMATTED}
          ... ì™¸ $((TOTAL - 10))ê°œ ì»¤ë°‹"
              fi
              {
                echo "log<<COMMITS_EOF"
                echo "$FORMATTED"
                echo "COMMITS_EOF"
              } >> "$GITHUB_OUTPUT"
            fi
          fi

      # 2. ìºì‹œ (ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: Cache Library
        if: github.event_name == 'push' || steps.changes.outputs.should_build == 'true'
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-WebGL-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-WebGL-
            Library-

      # 3. Unity ë¹Œë“œ
      - name: Build WebGL
        id: build
        if: github.event_name == 'push' || steps.changes.outputs.should_build == 'true'
        continue-on-error: true
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: WebGL
          buildProfile: "Assets/Settings/Build Profiles/Web - Desktop - Release.asset"

      # 4. ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      - name: Upload Build
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: WebGL-Build
          path: build/WebGL

      # 5. GitHub Pages ë°°í¬ ì¤€ë¹„
      - name: Setup Pages
        if: steps.build.outcome == 'success'
        uses: actions/configure-pages@v5

      # 6. Pagesìš© Artifact ì—…ë¡œë“œ
      - name: Upload Pages Artifact
        if: steps.build.outcome == 'success'
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/WebGL/WebGL

      # 7. GitHub Pages ë°°í¬
      - name: Deploy to GitHub Pages
        if: steps.build.outcome == 'success'
        uses: actions/deploy-pages@v4

      # 8. Butler ì„¤ì¹˜ & Itch.io ë°°í¬
      - name: Install Butler
        if: steps.build.outcome == 'success'
        run: |
          curl -L -o butler.zip https://broth.itch.zone/butler/linux-amd64/LATEST/archive/default
          unzip butler.zip
          chmod +x butler
          ./butler -V

      - name: Push to Itch.io
        if: steps.build.outcome == 'success'
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        run: |
          ./butler push build/WebGL/WebGL ${{ secrets.ITCHIO_GAME }}:html5

      # 9. ë¹Œë“œ ì‹¤íŒ¨ ì‹œ Geminië¡œ ì—ëŸ¬ ë¶„ì„
      - name: Analyze Build Error with Gemini
        id: analyze
        if: steps.build.outcome == 'failure'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          ERROR_FILE=/tmp/build_errors.txt
          touch "$ERROR_FILE"

          echo "=== ë¡œê·¸ íŒŒì¼ ê²€ìƒ‰ ==="
          find "$GITHUB_WORKSPACE" /home /tmp -name "*.log" -type f 2>/dev/null | head -10 | tee /tmp/log_files.txt

          while read -r f; do
            grep -i -E "error CS|error :|fatal|Build failed" "$f" 2>/dev/null | tail -20 >> "$ERROR_FILE"
          done < /tmp/log_files.txt

          if [ ! -s "$ERROR_FILE" ]; then
            echo "Build failed but no specific error logs were found." > "$ERROR_FILE"
          fi

          ERROR_LOG=$(tail -20 "$ERROR_FILE" | sed 's/\x1b\[[0-9;]*m//g' | head -c 1500)

          echo "=== ìˆ˜ì§‘ëœ ì—ëŸ¬ ë¡œê·¸ ==="
          echo "$ERROR_LOG"

          PROMPT="ë‹¤ìŒ Unity WebGL ë¹Œë“œ ì—ëŸ¬ ë¡œê·¸ë¥¼ ë¶„ì„í•´ì¤˜. í•œêµ­ì–´ë¡œ ì›ì¸ê³¼ í•´ê²°ë°©ë²•ì„ 3ì¤„ ì´ë‚´ë¡œ ì„¤ëª…. ë§ˆí¬ë‹¤ìš´ ê¸ˆì§€:\n\n${ERROR_LOG}"
          REQUEST_BODY=$(jq -n --arg prompt "$PROMPT" '{contents:[{parts:[{text:$prompt}]}]}')

          echo "=== Gemini ìš”ì²­ ë³¸ë¬¸ ==="
          echo "$REQUEST_BODY" | jq .

          GEMINI_URL="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}"
          RESPONSE=""
          for i in 1 2 3; do
            RESPONSE=$(curl -s "$GEMINI_URL" -H "Content-Type: application/json" -d "$REQUEST_BODY" || true)
            if echo "$RESPONSE" | jq -e '.candidates[0]' > /dev/null 2>&1; then
              break
            fi
            echo "=== ì‹œë„ $i ì‹¤íŒ¨, 15ì´ˆ í›„ ì¬ì‹œë„ ==="
            sleep 15
          done

          echo "=== Gemini ì‘ë‹µ ==="
          echo "$RESPONSE" | jq .

          ANALYSIS=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "AI ë¶„ì„ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."' | head -5)

          {
            echo "analysis<<ANALYSIS_EOF"
            echo "$ANALYSIS"
            echo "ANALYSIS_EOF"
          } >> "$GITHUB_OUTPUT"

      # 10. ìŠ¬ë™ ì•Œë¦¼ (ì„±ê³µ)
      - name: Slack Notification (Success)
        if: steps.build.outcome == 'success'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |
            text: "âœ… WebGL ë¹Œë“œ & ë°°í¬ ì„±ê³µ"
            blocks:
              - type: section
                text:
                  type: mrkdwn
                  text: |
                    âœ… *${{ github.repository }}* ë¹Œë“œ & ë°°í¬ ì™„ë£Œ!
                    ğŸ“ ì»¤ë°‹: ${{ github.event.head_commit.message }}
                    ğŸ‘¤ ì‘ì„±ì: ${{ github.actor }}
                    ğŸŒ <https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/|í”Œë ˆì´í•˜ê¸°>
                    ğŸ® <${{ secrets.ITCHIO_GAME_URL }}|Itch.ioì—ì„œ í”Œë ˆì´>
              - type: section
                text:
                  type: mrkdwn
                  text: |
                    ğŸ“‹ *ì´ì „ ë¹Œë“œ ì´í›„ ì»¤ë°‹ ë‚´ì—­:*
                    ${{ steps.commits.outputs.log }}

      # 11. ìŠ¬ë™ ì•Œë¦¼ (ì‹¤íŒ¨ + AI ë¶„ì„)
      - name: Slack Notification (Failure)
        if: steps.build.outcome == 'failure'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |
            text: "âŒ WebGL ë¹Œë“œ ì‹¤íŒ¨"
            blocks:
              - type: section
                text:
                  type: mrkdwn
                  text: |
                    ğŸ”¥ *${{ github.repository }}* ë¹Œë“œ ì‹¤íŒ¨!
                    ğŸ“ ì»¤ë°‹: ${{ github.event.head_commit.message }}
                    ğŸ‘¤ ì‘ì„±ì: ${{ github.actor }}
                    ğŸ”— <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ë¡œê·¸ í™•ì¸>
              - type: section
                text:
                  type: mrkdwn
                  text: |
                    ğŸ“‹ *ì´ì „ ë¹Œë“œ ì´í›„ ì»¤ë°‹ ë‚´ì—­:*
                    ${{ steps.commits.outputs.log }}
              - type: section
                text:
                  type: mrkdwn
                  text: |
                    ğŸ¤– *Gemini AI ë¶„ì„:*
                    ${{ steps.analyze.outputs.analysis }}

      # 12. ë¹Œë“œ ì‹¤íŒ¨ ì‹œ Jobì„ ì‹¤íŒ¨ ìƒíƒœë¡œ ë§ˆí‚¹
      - name: Fail job if build failed
        if: steps.build.outcome == 'failure'
        run: exit 1
